<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Immotools â€“ 6-Spalten (dezente Spaltenfarben & Diagramm)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  /* Grundfarben */
  --bg:#0e1117; --ink:#e9edf6; --muted:#9aa6b8;
  --card:#0f1420; --line:#1f2a3a;
  /* 6 dezente Spalten-HintergrÃ¼nde (ganzer KASTEN in der Farbe) */
  --c1:#111c2c;  /* Blau 1 */
  --c2:#12202b;  /* BlaugrÃ¼n 2 */
  --c3:#121c30;  /* Blau 3 */
  --c4:#151c28;  /* Nachtblau 4 */
  --c5:#161c22;  /* Graublau 5 */
  --c6:#14191f;  /* Graphit 6 */
  /* abgeleitete Rahmen */
  --b1:#21324a; --b2:#22424a; --b3:#24355a; --b4:#213044; --b5:#24313b; --b6:#242b33;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;font-size:0.8rem}

/* Kopf */
.header{position:sticky;top:0;z-index:10;background:rgba(17,24,39,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
.header .row{display:flex;align-items:center;gap:12px;padding:10px 14px}
.brand{font-weight:800;letter-spacing:.2px}

/* Grid */
.wrap{max-width:2000px;margin:0 auto;padding:12px}
.grid{display:grid;grid-template-columns:repeat(6,minmax(290px,1fr));gap:12px;align-items:start}

/* Karten & Sektionen */
.card{background:var(--card);border-radius:14px;padding:10px;border:1px solid var(--line)}
.card h2{margin:0 0 8px 0;font-size:0.78rem;text-transform:uppercase;letter-spacing:.32px}

.sec{border-radius:10px;padding:8px;margin-bottom:10px}
.col1 .sec{background:var(--c1);border:1px solid var(--b1)}
.col2 .sec{background:var(--c2);border:1px solid var(--b2)}
.col3 .sec{background:var(--c3);border:1px solid var(--b3)}
.col4 .sec{background:var(--c4);border:1px solid var(--b4)}
.col5 .sec{background:var(--c5);border:1px solid var(--b5)}
.col6 .sec{background:var(--c6);border:1px solid var(--b6)}

/* Tabelle */
.tbl{width:100%;border-collapse:collapse;font-size:0.78rem;table-layout:auto}
.tbl th,.tbl td{padding:6px 6px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle}
.tbl th{color:#c3cde0;text-align:left;font-weight:600}
.tbl td.val{text-align:right;white-space:nowrap;font-variant-numeric:tabular-nums}

/* Inputs: kompakt */
input[type="number"], input[type="text"]{
  height:22px; padding:1px 5px; border-radius:6px; border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25); color:var(--ink); font-size:0.78rem; outline:none; max-width:110px;
}
input.num{width:88px} input.short{width:64px} input.addr{width:100%; max-width:none; font-size:0.76rem; padding:1px 6px}

.kpi{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:8px;border-radius:10px;margin-top:8px}
.kpi .l{color:#c3cde0;font-size:0.72rem} .kpi .v{font-weight:800}
.note{font-size:0.72rem;color:#a9b3c5}
.full{grid-column:1/-1}

/* Chart */
.chartwrap{background:#0b1324;border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:2px}
canvas{width:100%;height:380px}

/* Toggle Box */
fieldset.toggle{border:1px dashed rgba(255,255,255,.12);border-radius:10px;padding:6px;margin:0}
fieldset.toggle legend{padding:0 6px;color:#cfe;font-size:0.76rem}
fieldset.toggle.disabled{opacity:.5}

/* Responsive */
@media(max-width:1700px){.grid{grid-template-columns:repeat(4,minmax(260px,1fr))}}
@media(max-width:1200px){.grid{grid-template-columns:repeat(2,minmax(260px,1fr))}}
@media(max-width:700px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="header"><div class="row"><div class="brand">ğŸ  Immotools</div></div></div>

<div class="wrap">
  <div class="grid">

    <!-- Spalte 1 -->
    <div class="card col1">
      <h2>Objekt & Kaufdatum</h2>
      <div class="sec">
        <table class="tbl">
          <tr><th>Adresse</th><td><input id="addr" class="addr" type="text" value="Musterstr. 11, 12345 Musterstadt"></td></tr>
          <tr><th>Kaufdatum</th><td class="val"><input id="date" class="short" type="text" value="01.01.24"> <span class="note">KÃ¼rzel</span> <input id="abbr" class="short" type="text" value="BoEl19"></td></tr>
          <tr><th>WohnflÃ¤che</th><td class="val"><input id="area" class="num" type="number" value="95"> mÂ² &nbsp; <span class="note">StellplÃ¤tze</span> <input id="slots" class="short" type="number" value="1"></td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Kaufpreis & Kaufnebenkosten</h3>
        <table class="tbl">
          <tr><th>Kaufpreis</th><td class="val"><input id="price" class="num" type="number" value="175000"> â‚¬</td></tr>
          <tr><th>pro mÂ²</th><td class="val" id="priceSqm">â€“</td></tr>
          <tr><th>Makler</th><td class="val"><input id="fee" class="short" type="number" value="0"> % (<span id="feeEur">â€“</span>)</td></tr>
          <tr><th>Notar</th><td class="val"><input id="notary" class="short" type="number" value="1.5"> % (<span id="notaryEur">â€“</span>)</td></tr>
          <tr><th>Grundbuch Amt</th><td class="val"><input id="landreg" class="short" type="number" value="0.5"> % (<span id="landregEur">â€“</span>)</td></tr>
          <tr><th>Grunderwerbsteuer</th><td class="val"><input id="taxRE" class="short" type="number" value="5"> % (<span id="taxREEur">â€“</span>)</td></tr>
          <tr><th>Sonstige</th><td class="val"><input id="miscAcq" class="short" type="number" value="0"> % (<span id="miscAcqEur">â€“</span>)</td></tr>
          <tr><th>Summe KNK</th><td class="val" id="knkSum">â€“</td></tr>
        </table>
        <div class="kpi"><div class="l">Gesamterwerb (KP + KNK)</div><div class="v" id="totalAcq">â€“</div></div>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">AnfÃ¤ngliche Investitionen</h3>
        <table class="tbl">
          <tr><th>KÃ¼che</th><td class="val"><input id="kitchen" class="num" type="number" value="2500"> â‚¬ <span class="note">Aktivieren</span> <input id="actKitchen" type="checkbox" checked></td></tr>
          <tr><th>Sonstiges</th><td class="val"><input id="capexOther" class="num" type="number" value="9000"> â‚¬ <span class="note">Aktivieren</span> <input id="actOther" type="checkbox" checked></td></tr>
          <tr><th>Summe</th><td class="val" id="capexSum">â€“</td></tr>
          <tr><th>15%-Grenze</th><td class="val" id="limit15">â€“</td></tr>
          <tr><th>Neuer Wert (KP + KNK)</th><td class="val" id="newValue">â€“</td></tr>
        </table>
        <div class="kpi"><div class="l">Gesamtinvestitionskosten</div><div class="v" id="totalInvest">â€“</div></div>
      </div>
    </div>

    <!-- Spalte 2 -->
    <div class="card col2">
      <h2>Miete, Steuern, RÃ¼cklagen</h2>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Soll-Miete pro Monat</h3>
        <table class="tbl">
          <tr><th>Kaltmiete â‚¬/mÂ²</th><td class="val"><input id="rentSqm" class="short" type="number" value="11.1"> â‚¬</td></tr>
          <tr><th>Kaltmiete gesamt</th><td class="val" id="coldRent">â€“</td></tr>
          <tr><th>+ StellplÃ¤tze</th><td class="val"><input id="rentSlots" class="short" type="number" value="45"> â‚¬</td></tr>
          <tr><th>+ Sonstiges</th><td class="val"><input id="rentOther" class="short" type="number" value="0"> â‚¬</td></tr>
          <tr><th>= Nettokaltmiete</th><td class="val" id="nettoCold">â€“</td></tr>
          <tr><th>+ UmlagefÃ¤hige Kosten</th><td class="val"><input id="umlagefaehig" class="num" type="number" value="399"> â‚¬</td></tr>
          <tr><th>= Warmmiete</th><td class="val" id="warmRent">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Steuern & AfA</h3>
        <table class="tbl">
          <tr><th>AfA-Satz</th><td class="val"><input id="afaRate" class="short" type="number" value="2"> % p.a.</td></tr>
          <tr><th>Anteil GebÃ¤ude am KP</th><td class="val"><input id="buildingShare" class="short" type="number" value="75"> %</td></tr>
          <tr><th>AfA-Basis</th><td class="val" id="afaBase">â€“</td></tr>
          <tr><th>AfA pro Monat</th><td class="val" id="afaMonth">â€“</td></tr>
          <tr><th>Grenzsteuersatz</th><td class="val"><input id="taxRate" class="short" type="number" value="26"> %</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">RÃ¼cklagen</h3>
        <table class="tbl">
          <tr><th>Kalk. Mietausfall</th><td class="val"><input id="vacancyPct" class="short" type="number" value="3"> %</td></tr>
          <tr><th>Eigene Instandh. (â‚¬/mÂ²Â·a)</th><td class="val"><input id="maintPerSqmYear" class="short" type="number" value="10"> â‚¬</td></tr>
          <tr><th>Empfohlen</th><td class="val" class="note">8â€“15 â‚¬/mÂ²Â·a</td></tr>
        </table>
      </div>
    </div>

    <!-- Spalte 3 -->
    <div class="card col3">
      <h2>Bewirtschaftungskosten</h2>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Bewirtschaftung pro Monat</h3>
        <table class="tbl">
          <tr><th>UmlagefÃ¤hig (Summe)</th><td class="val" id="bwuUml">â€“</td></tr>
          <tr><th>Nicht umlagefÃ¤hig</th><td class="val"><input id="nonApportion" class="num" type="number" value="173"> â‚¬</td></tr>
          <tr><th>% der Nettokaltmiete</th><td class="val" id="bwuPct">â€“</td></tr>
          <tr><th>Insgesamt</th><td class="val" id="bwuSum">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Hausgeld & Anteile</h3>
        <table class="tbl">
          <tr><th>Hausgeld gesamt</th><td class="val"><input id="hausgeld" class="num" type="number" value="439"> â‚¬</td></tr>
          <tr><th>UmlagefÃ¤hig</th><td class="val"><input id="hgUml" class="num" type="number" value="390"> â‚¬</td></tr>
          <tr><th>Nicht umlegbar</th><td class="val"><input id="hgNicht" class="num" type="number" value="49"> â‚¬</td></tr>
          <tr><th>Grundsteuer</th><td class="val"><input id="grundsteuer" class="num" type="number" value="9"> â‚¬</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Summen</h3>
        <table class="tbl">
          <tr><th>UmlagefÃ¤hige Kosten</th><td class="val" id="umlagSum">â€“</td></tr>
          <tr><th>Eigene InstandhaltungsrÃ¼ckl.</th><td class="val" id="eigeneRueckl">â€“</td></tr>
          <tr><th>Mietausfall (kalk.)</th><td class="val" id="leerstandEuro">â€“</td></tr>
          <tr><th>Nicht umlagefÃ¤hige Kosten</th><td class="val" id="nichtUmlSum">â€“</td></tr>
        </table>
      </div>
    </div>

    <!-- Spalte 4 -->
    <div class="card col4">
      <h2>Finanzierung</h2>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Gesamt-Finanzierung</h3>
        <table class="tbl">
          <tr><th>Eigenkapital %</th><td class="val"><input id="equityPct" class="short" type="number" value="13"> %</td></tr>
          <tr><th>Darlehenssumme</th><td class="val" id="loan">â€“</td></tr>
          <tr><th>Darlehen % Kaufpreis</th><td class="val" id="loanPct">â€“</td></tr>
          <tr><th>Eigenkapital</th><td class="val" id="equityAbs">â€“</td></tr>
          <tr><th>Gesamt-AnnuitÃ¤t/Monat</th><td class="val" id="annuity">â€“</td></tr>
          <tr><th>Gesamt Volltilgung (Jahr)</th><td class="val" id="yearFullAll">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Darlehen I</h3>
        <table class="tbl">
          <tr><th>Zinssatz</th><td class="val"><input id="iRate1" class="short" type="number" value="3.69"> %</td></tr>
          <tr><th>AnfÃ¤ngliche Tilgung</th><td class="val"><input id="iRepay1" class="short" type="number" value="2"> %</td></tr>
          <tr><th>Darlehenssumme</th><td class="val" id="loanI">â€“</td></tr>
          <tr><th>AnnuitÃ¤t / Monat</th><td class="val" id="iAnnuity">â€“</td></tr>
          <tr><th>Volltilgung (Jahr)</th><td class="val" id="yearFull1">â€“</td></tr>
        </table>
      </div>

      <fieldset class="toggle" id="dl2Field">
        <legend><label><input type="checkbox" id="loan2Enabled"> Zweites Darlehen aktivieren</label></legend>
        <div id="dl2Body" class="sec">
          <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Darlehen II</h3>
          <table class="tbl">
            <tr><th>Darlehenssumme</th><td class="val"><input id="loan2" class="num" type="number" value="0"> â‚¬</td></tr>
            <tr><th>Zinssatz</th><td class="val"><input id="iRate2" class="short" type="number" value="3"> %</td></tr>
            <tr><th>AnfÃ¤ngliche Tilgung</th><td class="val"><input id="iRepay2" class="short" type="number" value="1"> %</td></tr>
            <tr><th>AnnuitÃ¤t / Monat</th><td class="val" id="iAnnuity2">â€“</td></tr>
            <tr><th>Volltilgung (Jahr)</th><td class="val" id="yearFull2">â€“</td></tr>
          </table>
        </div>
      </fieldset>
    </div>

    <!-- Spalte 5 -->
    <div class="card col5">
      <h2>Kennzahlen heute</h2>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">VermÃ¶genszuwachs</h3>
        <table class="tbl">
          <tr><th>VermÃ¶genszuwachs p.a.</th><td class="val" id="wealthPa">â€“</td></tr>
          <tr><th>ohne Wertsteigerung</th><td class="val" id="wealthNoAppr">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Miete & Mietrendite</h3>
        <table class="tbl">
          <tr><th>Nettokaltmiete pro Jahr</th><td class="val" id="coldRentYear">â€“</td></tr>
          <tr><th>Bruttomietrendite</th><td class="val" id="grossYield">â€“</td></tr>
          <tr><th>Faktor</th><td class="val" id="faktor">â€“</td></tr>
          <tr><th>Nettomietrendite</th><td class="val" id="netYield">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Cashflow pro Monat</h3>
        <table class="tbl">
          <tr><th>Warmmiete</th><td class="val" id="cfWarm">â€“</td></tr>
          <tr><th>- Bewirtschaftungskosten</th><td class="val" id="cfBwu">â€“</td></tr>
          <tr><th>- Zinsen</th><td class="val" id="cfInterest">â€“</td></tr>
          <tr><th>- Tilgung</th><td class="val" id="cfRepay">â€“</td></tr>
          <tr><th>= Operativ</th><td class="val" id="cfOper">â€“</td></tr>
          <tr><th>- Steuern</th><td class="val" id="cfTax">â€“</td></tr>
          <tr><th>= Nach Steuern</th><td class="val" id="cfAfterTax">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Nebenrechnung Steuer (Monat)</h3>
        <table class="tbl">
          <tr><th>Warmmiete</th><td class="val" id="taxWarm">â€“</td></tr>
          <tr><th>- Bew.-Kosten ohne eigene RÃ¼ckl.</th><td class="val" id="taxBwu">â€“</td></tr>
          <tr><th>- Zinsen</th><td class="val" id="taxInterest">â€“</td></tr>
          <tr><th>- Abschreibung (AfA)</th><td class="val" id="taxAfa">â€“</td></tr>
          <tr><th>= zu versteuernder Cashflow</th><td class="val" id="taxable">â€“</td></tr>
          <tr><th>* Grenzsteuersatz</th><td class="val" id="taxRateShow">â€“</td></tr>
          <tr><th>= Steuern</th><td class="val" id="taxDue">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Eigenkapitalrendite</h3>
        <table class="tbl">
          <tr><th>Eigenkapitalrendite p.a.</th><td class="val" id="roePa">â€“</td></tr>
          <tr><th>ohne Wertsteigerung</th><td class="val" id="roeNoAppr">â€“</td></tr>
        </table>
      </div>
    </div>

    <!-- Spalte 6 -->
    <div class="card col6">
      <h2>Kennzahlen Zukunft & Risiko</h2>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Betrachtungszeitpunkt</h3>
        <table class="tbl">
          <tr><th>Hochrechnung fÃ¼r das Jahr</th><td class="val" id="yearAt">â€“</td></tr>
          <tr><th>Jahre seit Kauf</th><td class="val"><input id="yearsFwd" class="short" type="number" value="17"></td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Miete & Wert</h3>
        <table class="tbl">
          <tr><th>Nettokaltmiete p.a.</th><td class="val" id="fwdRentYear">â€“</td></tr>
          <tr><th>pro qm & Monat</th><td class="val" id="fwdPerSqm">â€“</td></tr>
          <tr><th>Wert der Immobilie (Jahresende)</th><td class="val" id="fwdValue">â€“</td></tr>
          <tr><th>pro qm</th><td class="val" id="fwdPerSqmValue">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Cashflow (Zukunft)</h3>
        <table class="tbl">
          <tr><th>Warmmiete</th><td class="val" id="fwdWarm">â€“</td></tr>
          <tr><th>- Bewirtschaftungskosten</th><td class="val" id="fwdBwu">â€“</td></tr>
          <tr><th>- Zinsen</th><td class="val" id="fwdInterest">â€“</td></tr>
          <tr><th>- Tilgung</th><td class="val" id="fwdRepay">â€“</td></tr>
          <tr><th>= Operativ</th><td class="val" id="fwdOper">â€“</td></tr>
          <tr><th>- Steuern</th><td class="val" id="fwdTax">â€“</td></tr>
          <tr><th>= Nach Steuern</th><td class="val" id="fwdAfterTax">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">ZinsÃ¤nderungsrisiko</h3>
        <table class="tbl">
          <tr><th>Monatl. Zinsen fÃ¼r CF 0 n. St.</th><td class="val" id="riskIntNeeded">â€“</td></tr>
          <tr><th>= Zinssatz gewichtet (p.a.)</th><td class="val" id="riskRate">â€“</td></tr>
        </table>
      </div>

      <div class="sec">
        <h3 style="margin:0 0 6px 2px;font-size:.76rem;color:#cfe">Prognose-Parameter</h3>
        <table class="tbl">
          <tr><th>Kostensteigerung p.a.</th><td class="val"><input id="costGrowth" class="short" type="number" value="5"> %</td></tr>
          <tr><th>Mietsteigerung p.a.</th><td class="val"><input id="rentGrowth" class="short" type="number" value="7"> %</td></tr>
          <tr><th>Wertsteigerung p.a.</th><td class="val"><input id="valueGrowth" class="short" type="number" value="2"> %</td></tr>
        </table>
      </div>
    </div>

    <!-- Diagramm -->
    <div class="card full">
      <h2>Amortisations-Diagramm</h2>
      <div class="chartwrap"><canvas id="amo"></canvas></div>
      <div class="note">Gestapelt: Zins/Tilgung pro Jahr (DL I + DL II). Linie: Restschuld. Live-Update bei Eingaben.</div>
    </div>

  </div>
</div>

<script>
const $ = id => document.getElementById(id);
function eur(n,d=0){return (isFinite(n)?n:0).toLocaleString('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:d});}
function pct(n,d=1){return (isFinite(n)?n:0).toFixed(d)+' %';}
const Y = ()=>new Date().getFullYear();

function read(){
  return {
    area:+$('area').value||0, price:+$('price').value||0,
    fee:+$('fee').value||0, notary:+$('notary').value||0, landreg:+$('landreg').value||0, taxRE:+$('taxRE').value||0, miscAcq:+$('miscAcq').value||0,
    kitchen:+$('kitchen').value||0, capexOther:+$('capexOther').value||0, actKitchen:$('actKitchen').checked, actOther:$('actOther').checked,
    rentSqm:+$('rentSqm').value||0, rentSlots:+$('rentSlots').value||0, rentOther:+$('rentOther').value||0, umlagefaehig:+$('umlagefaehig').value||0,
    vacancyPct:+$('vacancyPct').value||0, maintPerSqmYear:+$('maintPerSqmYear').value||0,
    nonApportion:+$('nonApportion').value||0, hausgeld:+$('hausgeld').value||0, hgUml:+$('hgUml').value||0, grundsteuer:+$('grundsteuer').value||0,
    hgNicht:+$('hgNicht').value||0,
    equityPct:+$('equityPct').value||0,
    iRate1:+$('iRate1').value||0, iRepay1:+$('iRepay1').value||0,
    loan2Enabled:$('loan2Enabled').checked, loan2:+$('loan2').value||0, iRate2:+$('iRate2').value||0, iRepay2:+$('iRepay2').value||0,
    buildingShare:+$('buildingShare').value||0, afaRate:+$('afaRate').value||0, taxRate:+$('taxRate').value||0,
    yearsFwd:+$('yearsFwd').value||0, rentGrowth:+$('rentGrowth').value||0, costGrowth:+$('costGrowth').value||0, valueGrowth:+$('valueGrowth').value||0
  };
}

function calc(p){
  const priceSqm = p.area>0 ? p.price/p.area : 0;
  const knkPct = (p.fee+p.notary+p.landreg+p.taxRE+p.miscAcq)/100;
  const knkSum = p.price*knkPct;
  const totalAcq = p.price + knkSum;
  const feeEur = p.price*(p.fee/100), notaryEur = p.price*(p.notary/100), landregEur = p.price*(p.landreg/100), taxREEur = p.price*(p.taxRE/100), miscAcqEur = p.price*(p.miscAcq/100);

  const capexSum = p.kitchen + p.capexOther;
  const totalInvest = totalAcq + capexSum;

  const coldRent = p.area*p.rentSqm;
  const nettoCold = coldRent + p.rentSlots + p.rentOther;
  const warmRent = nettoCold + p.umlagefaehig;

  const umlagSum = (p.hgUml||0) + (p.grundsteuer||0);
  const eigeneRueckl = (p.area*p.maintPerSqmYear)/12;
  const leerstandEuro = nettoCold*(p.vacancyPct/100);
  const nichtUmlSum = (p.hgNicht||0) + eigeneRueckl + leerstandEuro + (p.nonApportion||0);
  const bwuSum = umlagSum + (p.nonApportion||0) + nichtUmlSum;
  const bwuPct = nettoCold>0 ? (bwuSum/nettoCold*100) : 0;

  const equityAbs = totalAcq*(p.equityPct/100);
  const loanTotal = Math.max(totalAcq - equityAbs,0);
  const loan2 = (p.loan2Enabled ? Math.min(p.loan2, loanTotal) : 0);
  const loan1 = Math.max(loanTotal - loan2, 0);

  const ann1 = loan1*((p.iRate1 + p.iRepay1)/100/12);
  const iMonth1 = loan1*(p.iRate1/100/12);
  const rMonth1 = Math.max(0, ann1 - iMonth1);

  const ann2 = loan2*((p.iRate2 + p.iRepay2)/100/12);
  const iMonth2 = loan2*(p.iRate2/100/12);
  const rMonth2 = Math.max(0, ann2 - iMonth2);

  const annuity = ann1 + ann2;
  const interestMonth = iMonth1 + iMonth2;
  const repayMonth = rMonth1 + rMonth2;

  const activated = (p.actKitchen?p.kitchen:0)+(p.actOther?p.capexOther:0);
  const afaBase = (p.price + knkSum)*(p.buildingShare/100) + activated;
  const afaMonth = afaBase*(p.afaRate/100)/12;
  const bwuForTax = umlagSum + (p.nonApportion||0);
  const taxable = Math.max(0, warmRent - bwuForTax - interestMonth - afaMonth);
  const taxMonth = taxable*(p.taxRate/100);

  const cfOper = warmRent - bwuSum - annuity;
  const cfAfterTax = cfOper - taxMonth + repayMonth;

  const coldYear = nettoCold*12;
  const grossYield = p.price>0 ? coldYear/p.price*100 : 0;
  const faktor = coldYear>0 ? p.price/coldYear : 0;
  const netYield = totalInvest>0 ? ((coldYear - (nichtUmlSum+p.nonApportion)*12)/totalInvest*100) : 0;

  const yearAt = Y()+p.yearsFwd;
  const coldYearFwd = coldYear*Math.pow(1+p.rentGrowth/100,p.yearsFwd);
  const fwdPerSqm = p.area>0 ? ((coldYearFwd/12)/p.area) : 0;
  const valueFwd = totalAcq*Math.pow(1+p.valueGrowth/100,p.yearsFwd);
  const bwuSumFwd = bwuSum*Math.pow(1+p.costGrowth/100,p.yearsFwd);
  const warmFwd = (coldYearFwd/12)+p.umlagefaehig;
  const operFwd = warmFwd - bwuSumFwd - interestMonth - repayMonth;
  const taxableFwd = Math.max(0, warmFwd - bwuForTax*Math.pow(1+p.costGrowth/100,p.yearsFwd) - interestMonth - afaMonth);
  const taxFwd = taxableFwd*(p.taxRate/100);
  const afterTaxFwd = operFwd - taxFwd + repayMonth;

  const principalYear = repayMonth*12;
  const apprYear = totalAcq*(p.valueGrowth/100);
  const wealthPa = principalYear + apprYear;
  const wealthNoAppr = principalYear;
  const roePa = (equityAbs>0) ? (wealthPa/equityAbs*100) : 0;
  const roeNoAppr = (equityAbs>0) ? (wealthNoAppr/equityAbs*100) : 0;

  const tRate = p.taxRate/100;
  const A = warmRent - bwuSum;
  const B = warmRent - bwuForTax - afaMonth;
  const Ineeded = (A - tRate*B) / (1 - tRate);
  const riskRatePa = loanTotal>0 ? (Ineeded*12/loanTotal*100) : 0;

  function payoffYear(principal, ir, tr){
    const im = ir/100/12, ann = principal*((ir+tr)/100/12);
    if(principal<=0 || im<=0 || ann<=im*principal) return null;
    const nMonths = Math.log(ann/(ann-im*principal))/Math.log(1+im);
    return Math.floor(Y() + nMonths/12);
  }
  const year1 = payoffYear(loan1, p.iRate1, p.iRepay1);
  const year2 = p.loan2Enabled ? payoffYear(loan2, p.iRate2, p.iRepay2) : null;
  const yearAll = Math.max(year1||0, year2||0) || (year1||null);

  return {priceSqm, feeEur, notaryEur, landregEur, taxREEur, miscAcqEur,
    knkSum,totalAcq,capexSum,totalInvest, coldRent,nettoCold,warmRent,
    umlagSum,eigeneRueckl,leerstandEuro,nichtUmlSum,bwuSum,bwuPct,
    equityAbs,loanTotal,loan1,loan2,ann1,ann2,annuity,interestMonth,repayMonth,
    afaBase,afaMonth,taxable,taxMonth, coldYear,grossYield,faktor,netYield,
    yearAt,coldYearFwd,fwdPerSqm,valueFwd,bwuSumFwd,warmFwd,operFwd,taxFwd,afterTaxFwd,
    wealthPa,wealthNoAppr,roePa,roeNoAppr, Ineeded,riskRatePa, year1,year2,yearAll};
}

let chart;
function drawChart(){
  const p = read(); const m = calc(p);

  function series(principal, ir, tr){
    const months = 40*12;
    let bal = principal; const im = ir/100/12; const ann = principal*((ir+tr)/100/12);
    const Z=[],T=[],L=[]; let done=false;
    for(let k=1;k<=months;k++){
      const i = bal*im; const r = Math.min(ann - i, bal); bal=Math.max(0, bal-r);
      if(k%12===0){ Z.push(i*12); T.push(r*12); L.push('J'+(k/12)); }
      if(bal<=0 && !done){done=true;}
      if(done && k%12===0) break;
    }
    return {Z,T,L};
  }

  const mCalc = calc(read());
  const s1 = series(mCalc.loan1, +$('iRate1').value||0, +$('iRepay1').value||0);
  const has2 = $('loan2Enabled').checked;
  const s2 = has2 ? series(mCalc.loan2, +$('iRate2').value||0, +$('iRepay2').value||0) : {Z:[],T:[],L:[]};

  const len = Math.max(s1.L.length, s2.L.length);
  const labels=[], z=[], t=[], rest=[];
  let bal1=mCalc.loan1, bal2=has2?mCalc.loan2:0;
  const im1=(+$('iRate1').value||0)/100/12, im2=(+$('iRate2').value||0)/100/12;
  const ann1=mCalc.ann1, ann2=mCalc.ann2;

  for(let i=0;i<len;i++){
    labels.push('J'+(i+1));
    z.push((s1.Z[i]||0)+(s2.Z[i]||0));
    t.push((s1.T[i]||0)+(s2.T[i]||0));
    for(let k=0;k<12;k++){
      const i1=bal1*im1, r1=Math.min(ann1 - i1, bal1); bal1=Math.max(0, bal1-r1);
      const i2=bal2*im2, r2=Math.min(ann2 - i2, bal2); bal2=Math.max(0, bal2-r2);
    }
    rest.push(bal1+bal2);
    if(bal1+bal2<=0) break;
  }

  const cfg = {
    data:{labels,datasets:[
      {type:'bar', label:'Zinsen/Jahr', data:z, stack:'am'},
      {type:'bar', label:'Tilgung/Jahr', data:t, stack:'am'},
      {type:'line', label:'Restschuld', data:rest, yAxisID:'y1'}
    ]},
    options:{plugins:{legend:{position:'top'}}, responsive:true,
      scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}, y1:{position:'right', beginAtZero:true}}}
  };
  if(chart) chart.destroy();
  chart = new Chart($('amo').getContext('2d'), cfg);
}

function render(){
  const p = read(); const m = calc(p);

  $('priceSqm').textContent = eur(m.priceSqm,0);
  $('knkSum').textContent = eur(m.knkSum);
  $('totalAcq').textContent = eur(m.totalAcq);
  $('feeEur').textContent = eur(m.feeEur);
  $('notaryEur').textContent = eur(m.notaryEur);
  $('landregEur').textContent = eur(m.landregEur);
  $('taxREEur').textContent = eur(m.taxREEur);
  $('miscAcqEur').textContent = eur(m.miscAcqEur);

  $('capexSum').textContent = eur(m.capexSum);
  $('limit15').textContent = eur(m.totalAcq*0.15*0.75*1.19);
  $('newValue').textContent = eur(m.totalAcq);
  $('totalInvest').textContent = eur(m.totalInvest);

  $('coldRent').textContent = eur(m.coldRent);
  $('nettoCold').textContent = eur(m.coldRent + (+$('rentSlots').value||0) + (+$('rentOther').value||0));
  $('warmRent').textContent = eur(m.warmRent);
  $('afaBase').textContent = eur(m.afaBase);
  $('afaMonth').textContent = eur(m.afaMonth);

  $('bwuUml').textContent = eur(m.umlagSum);
  $('bwuPct').textContent = pct(m.bwuPct);
  $('bwuSum').textContent = eur(m.bwuSum);
  $('umlagSum').textContent = eur(m.umlagSum);
  $('eigeneRueckl').textContent = eur((+$('area').value||0)*(+$('maintPerSqmYear').value||0)/12);
  $('leerstandEuro').textContent = eur((+$('vacancyPct').value||0)/100*((+$('area').value||0)*(+$('rentSqm').value||0)+(+$('rentSlots').value||0)+(+$('rentOther').value||0)));

  $('loan').textContent = eur(m.loanTotal);
  $('loanPct').textContent = pct(m.loanTotal/((+$('price').value||1))*100,1);
  $('equityAbs').textContent = eur(m.equityAbs);
  $('loanI').textContent = eur(m.loan1);
  $('iAnnuity').textContent = eur(m.ann1);
  $('yearFull1').textContent = m.year1 ?? 'â€“';
  $('iAnnuity2').textContent = eur(m.ann2);
  $('yearFull2').textContent = m.year2 ?? 'â€“';
  $('annuity').textContent = eur(m.annuity);
  $('yearFullAll').textContent = m.yearAll ?? 'â€“';

  $('wealthPa').textContent = eur(m.wealthPa);
  $('wealthNoAppr').textContent = eur(m.wealthNoAppr);
  $('coldRentYear').textContent = eur(m.coldYear);
  $('grossYield').textContent = pct(m.grossYield);
  $('faktor').textContent = (isFinite(m.faktor)?m.faktor:0).toFixed(1);
  $('netYield').textContent = pct(m.netYield);

  $('cfWarm').textContent = eur(m.warmRent);
  $('cfBwu').textContent = eur(m.bwuSum);
  $('cfInterest').textContent = eur(m.interestMonth);
  $('cfRepay').textContent = eur(m.repayMonth);
  $('cfOper').textContent = eur(m.cfOper);
  $('cfTax').textContent = eur(m.taxMonth);
  $('cfAfterTax').textContent = eur(m.cfAfterTax);

  $('taxWarm').textContent = eur(m.warmRent);
  $('taxBwu').textContent = eur(m.umlagSum + (+$('nonApportion').value||0));
  $('taxInterest').textContent = eur(m.interestMonth);
  $('taxAfa').textContent = eur(m.afaMonth);
  $('taxable').textContent = eur(m.taxable);
  $('taxRateShow').textContent = pct((+$('taxRate').value||0));
  $('taxDue').textContent = eur(m.taxMonth);

  $('roePa').textContent = pct(m.roePa);
  $('roeNoAppr').textContent = pct(m.roeNoAppr);

  $('yearAt').textContent = m.yearAt;
  $('fwdRentYear').textContent = eur(m.coldYearFwd);
  $('fwdPerSqm').textContent = (m.fwdPerSqm||0).toFixed(1)+' â‚¬/mÂ²Â·Monat';
  $('fwdValue').textContent = eur(m.valueFwd);
  $('fwdPerSqmValue').textContent = ((m.valueFwd/(+$('area').value||1))||0).toFixed(0)+' â‚¬/mÂ²';
  $('fwdWarm').textContent = eur(m.warmFwd);
  $('fwdBwu').textContent = eur(m.bwuSumFwd);
  $('fwdInterest').textContent = eur(m.interestMonth);
  $('fwdRepay').textContent = eur(m.repayMonth);
  $('fwdOper').textContent = eur(m.operFwd);
  $('fwdTax').textContent = eur(m.taxFwd);
  $('fwdAfterTax').textContent = eur(m.afterTaxFwd);

  $('riskIntNeeded').textContent = eur(m.Ineeded);
  $('riskRate').textContent = pct(m.riskRatePa);

  drawChart();
}

function setLoan2Enabled(on){
  const fld = $('dl2Field'), body = $('dl2Body');
  $('loan2Enabled').checked = on; fld.classList.toggle('disabled', !on);
  body.style.display = on ? 'block' : 'none';
  render();
}

function bind(){
  document.querySelectorAll('input').forEach(i=> i.addEventListener('input', render));
  $('loan2Enabled').addEventListener('change', e=> setLoan2Enabled(e.target.checked));
  setLoan2Enabled(false);  // Start: DL2 aus
}

window.addEventListener('DOMContentLoaded', ()=>{ bind(); render(); });
</script>
</body>
</html>